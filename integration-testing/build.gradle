/*
 * Copyright 2016-2021 JetBrains s.r.o. Use of this source code is governed by the Apache 2.0 license.
 */

import org.jetbrains.kotlin.gradle.plugin.KotlinPlatformType

plugins {
    id "org.jetbrains.kotlin.jvm" version "1.6.20"
}

repositories {
    mavenLocal()
    mavenCentral()
}

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

dependencies {
    testImplementation "org.jetbrains.kotlin:kotlin-test:$kotlin_version"
    // Workaround to make addSuppressed work in tests
    testImplementation "org.jetbrains.kotlin:kotlin-reflect:$kotlin_version"
    //testImplementation "org.jetbrains.kotlin:kotlin-test-js:$kotlin_version"
    //testImplementation "junit:junit:$junit_version"
}

sourceSets {
    mavenTest {
        kotlin
        compileClasspath += sourceSets.test.runtimeClasspath
        runtimeClasspath += sourceSets.test.runtimeClasspath
    }
    debugAgentTest {
        kotlin
        compileClasspath += sourceSets.test.runtimeClasspath
        runtimeClasspath += sourceSets.test.runtimeClasspath
    }
    coreAgentTest {
        kotlin
        compileClasspath += sourceSets.test.runtimeClasspath
        runtimeClasspath += sourceSets.test.runtimeClasspath
    }
}

compileDebugAgentTestKotlin {
    kotlinOptions {
        freeCompilerArgs += ["-Xallow-kotlin-package"]
    }
}

task mavenTest(type: Test) {
    environment "version", coroutines_version
    def sourceSet = sourceSets.mavenTest
    testClassesDirs = sourceSet.output.classesDirs
    classpath = sourceSet.runtimeClasspath
}

//task debugAgentTest(type: Test) {
//    def sourceSet = sourceSets.debugAgentTest
//    dependsOn(project(':kotlinx-coroutines-debug').shadowJar)
//    jvmArgs ('-javaagent:' + project(':kotlinx-coroutines-debug').shadowJar.outputs.files.getFiles()[0])
//    testClassesDirs = sourceSet.output.classesDirs
//    classpath = sourceSet.runtimeClasspath
//    systemProperties project.properties.subMap(["overwrite.probes"])
//}
//
//task coreAgentTest(type: Test) {
//    def sourceSet = sourceSets.coreAgentTest
//    dependsOn(project(':kotlinx-coroutines-core').jvmJar)
//    jvmArgs ('-javaagent:' + project(':kotlinx-coroutines-core').jvmJar.outputs.files.getFiles()[0])
//    testClassesDirs = sourceSet.output.classesDirs
//    classpath = sourceSet.runtimeClasspath
//}

dependencies {
    testImplementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
    testImplementation 'junit:junit:4.12'
    mavenTestImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$coroutines_version"
    mavenTestImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$coroutines_version"
//    debugAgentTestImplementation project(':kotlinx-coroutines-core')
//    debugAgentTestImplementation project(':kotlinx-coroutines-debug')
//    coreAgentTestImplementation project(':kotlinx-coroutines-core')
}

compileTestKotlin {
    kotlinOptions.jvmTarget = "1.8"
}

check {
    dependsOn([mavenTest])
}
