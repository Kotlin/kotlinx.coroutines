<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>kotlinx-coroutines-debug</title>
  <meta name="description" content="Library support for kotlin coroutines">
  <link rel="stylesheet" href="/kotlinx.coroutines/assets/main.css">
  <link rel="canonical" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="/kotlinx.coroutines/assets/js/api.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-47631155-3', 'auto');
    ga('send', 'pageview');
  </script>
</head>

  <body>
    <header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" href="/kotlinx.coroutines/">kotlinx.coroutines</a>
  </div>
</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <p>Debugging facilities for <code>kotlinx.coroutines</code> on JVM.</p>

<h3 id="overview">Overview</h3>

<p>This module provides a debug JVM agent that allows to track and trace existing coroutines.
The main entry point to debug facilities is <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/index.html">DebugProbes</a> API.
Call to <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/install.html">DebugProbes.install</a> installs debug agent via ByteBuddy and starts spying on coroutines when they are created, suspended and resumed.</p>

<p>After that, you can use <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/dump-coroutines.html">DebugProbes.dumpCoroutines</a> to print all active (suspended or running) coroutines, including their state, creation and
suspension stacktraces.
Additionally, it is possible to process the list of such coroutines via <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/dump-coroutines-info.html">DebugProbes.dumpCoroutinesInfo</a> or dump isolated parts
of coroutines hierarchy referenced by a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a> or <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">CoroutineScope</a> instances using  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/print-job.html">DebugProbes.printJob</a> and <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/print-scope.html">DebugProbes.printScope</a> respectively.</p>

<p>This module also provides an automatic <a href="https://github.com/reactor/BlockHound">BlockHound</a> integration
that detects when a blocking operation was called in a coroutine context that prohibits it. In order to use it,
please follow the BlockHound <a href="https://github.com/reactor/BlockHound/blob/1.0.2.RELEASE/docs/quick_start.md">quick start guide</a>.</p>

<h3 id="using-in-your-project">Using in your project</h3>

<p>Add <code>kotlinx-coroutines-debug</code> to your project test dependencies:</p>

<pre>dependencies {
    testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-debug:1.3.8'
}
</pre>

<h3 id="using-in-unit-tests">Using in unit tests</h3>

<p>For JUnit4 debug module provides special test rule, <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug.junit4/-coroutines-timeout/index.html">CoroutinesTimeout</a>, for installing debug probes
and to dump coroutines on timeout to simplify tests debugging.</p>

<p>Its usage is better demonstrated by the example (runnable code is <a href="test/TestRuleExample.kt">here</a>):</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TestRuleExample</span> <span class="p">{</span>
    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Rule</span>
    <span class="k">public</span> <span class="kd">val</span> <span class="py">timeout</span> <span class="p">=</span> <span class="nc">CoroutinesTimeout</span><span class="p">.</span><span class="nf">seconds</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>

    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">someFunctionDeepInTheStack</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">delay</span><span class="p">(</span><span class="nc">Long</span><span class="p">.</span><span class="nc">MAX_VALUE</span><span class="p">)</span> <span class="c1">// Hang method</span>
        <span class="p">}</span>  
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">hangingTest</span><span class="p">()</span> <span class="p">=</span> <span class="nf">runBlocking</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">job</span> <span class="p">=</span> <span class="nf">launch</span> <span class="p">{</span>
            <span class="nf">someFunctionDeepInTheStack</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">job</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span> <span class="c1">// Join will hang</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After 1 second, test will fail with <code>TestTimeoutException</code> and all coroutines (<code>runBlocking</code> and <code>launch</code>) and their
stacktraces will be dumped to the console.</p>

<h3 id="using-as-jvm-agent">Using as JVM agent</h3>

<p>Debug module can also be used as a standalone JVM agent to enable debug probes on the application startup.
You can run your application with an additional argument: <code>-javaagent:kotlinx-coroutines-debug-1.3.8.jar</code>.
Additionally, on Linux and Mac OS X you can use <code>kill -5 $pid</code> command in order to force your application to print all alive coroutines.
When used as Java agent, <code>"kotlinx.coroutines.debug.enable.creation.stack.trace"</code> system property can be used to control 
<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/enable-creation-stack-traces.html">DebugProbes.enableCreationStackTraces</a> along with agent startup.</p>

<h3 id="using-in-production-environment">Using in production environment</h3>

<p>It is possible to run an application in production environments with debug probes in order to monitor its 
state and improve its observability. 
For that, it is strongly recommended to switch off <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/enable-creation-stack-traces.html">DebugProbes.enableCreationStackTraces</a> property to significantly 
reduce the overhead of debug probes and make it insignificant.
With creation stack-traces disabled, the typical overhead of enabled debug probes is a single-digit percentage of the total
application throughput.</p>

<h3 id="example-of-usage">Example of usage</h3>

<p>Capabilities of this module can be demonstrated by the following example 
(runnable code is <a href="test/Example.kt">here</a>):</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">computeValue</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="nf">coroutineScope</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">one</span> <span class="p">=</span> <span class="nf">async</span> <span class="p">{</span> <span class="nf">computeOne</span><span class="p">()</span> <span class="p">}</span>
    <span class="kd">val</span> <span class="py">two</span> <span class="p">=</span> <span class="nf">async</span> <span class="p">{</span> <span class="nf">computeTwo</span><span class="p">()</span> <span class="p">}</span>
    <span class="nf">combineResults</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">combineResults</span><span class="p">(</span><span class="n">one</span><span class="p">:</span> <span class="nc">Deferred</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;,</span> <span class="n">two</span><span class="p">:</span> <span class="nc">Deferred</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">String</span> <span class="p">=</span>
    <span class="n">one</span><span class="p">.</span><span class="nf">await</span><span class="p">()</span> <span class="p">+</span> <span class="n">two</span><span class="p">.</span><span class="nf">await</span><span class="p">()</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">computeOne</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="nf">delay</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"4"</span>
<span class="p">}</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">computeTwo</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="nf">delay</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"2"</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="nf">runBlocking</span> <span class="p">{</span>
    <span class="nc">DebugProbes</span><span class="p">.</span><span class="nf">install</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">deferred</span> <span class="p">=</span> <span class="nf">async</span> <span class="p">{</span> <span class="nf">computeValue</span><span class="p">()</span> <span class="p">}</span>
    <span class="c1">// Delay for some time</span>
    <span class="nf">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
    <span class="c1">// Dump running coroutines</span>
    <span class="nc">DebugProbes</span><span class="p">.</span><span class="nf">dumpCoroutines</span><span class="p">()</span>
    <span class="nf">println</span><span class="p">(</span><span class="s">"\nDumping only deferred"</span><span class="p">)</span>
    <span class="nc">DebugProbes</span><span class="p">.</span><span class="nf">printJob</span><span class="p">(</span><span class="n">deferred</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Printed result will be:</p>

<pre>Coroutines dump 2018/11/12 21:44:02

Coroutine "coroutine#2":DeferredCoroutine{Active}@289d1c02, state: SUSPENDED
	at kotlinx.coroutines.DeferredCoroutine.await$suspendImpl(Builders.common.kt:99)
	at ExampleKt.combineResults(Example.kt:11)
	at ExampleKt$computeValue$2.invokeSuspend(Example.kt:7)
	at ExampleKt$main$1$deferred$1.invokeSuspend(Example.kt:25)
	(Coroutine creation stacktrace)
	at kotlin.coroutines.intrinsics.IntrinsicsKt__IntrinsicsJvmKt.createCoroutineUnintercepted(IntrinsicsJvm.kt:116)
	at kotlinx.coroutines.intrinsics.CancellableKt.startCoroutineCancellable(Cancellable.kt:25)
	at kotlinx.coroutines.BuildersKt.async$default(Unknown Source)
	at ExampleKt$main$1.invokeSuspend(Example.kt:25)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:32)
	at kotlinx.coroutines.DispatchedTask.run(Dispatched.kt:233)
	at kotlinx.coroutines.BuildersKt.runBlocking$default(Unknown Source)
	at ExampleKt.main(Example.kt:23)
	at ExampleKt.main(Example.kt)

... More coroutines here ...

Dumping only deferred
"coroutine#2":DeferredCoroutine{Active}, continuation is SUSPENDED at line kotlinx.coroutines.DeferredCoroutine.await$suspendImpl(Builders.common.kt:99)
			"coroutine#3":DeferredCoroutine{Active}, continuation is SUSPENDED at line ExampleKt.computeOne(Example.kt:14)
		"coroutine#4":DeferredCoroutine{Active}, continuation is SUSPENDED at line ExampleKt.computeTwo(Example.kt:19)
</pre>

<h3 id="status-of-the-api">Status of the API</h3>

<p>API is experimental, and it is not guaranteed it wonâ€™t be changed (while it is marked as <code>@ExperimentalCoroutinesApi</code>).
Like the rest of experimental API, <code>DebugProbes</code> is carefully designed, tested and ready to use in both test and production 
environments. It is marked as experimental to leave us the room to enrich the output data in a potentially backwards incompatible manner
to further improve diagnostics and debugging experience.</p>

<p>The output format of <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/index.html">DebugProbes</a> can be changed in the future and it is not recommended to rely on the string representation
of the dump programmatically.</p>

<h3 id="debug-agent-and-android">Debug agent and Android</h3>

<p>Unfortunately, Android runtime does not support Instrument API necessary for <code>kotlinx-coroutines-debug</code> to function, triggering <code>java.lang.NoClassDefFoundError: Failed resolution of: Ljava/lang/management/ManagementFactory;</code>.</p>

<p>Nevertheless, it will be possible to support debug agent on Android as soon as <a href="https://github.com/Archinamon/android-gradle-aspectj">GradleAspectJ-Android</a>  will support android-gradle 3.3</p>

<h3 id="packages">Packages</h3>

<table class="api-docs-table">
<tbody>
<tr>
<td>

        <p><a href="kotlinx.coroutines.debug/index.html">kotlinx.coroutines.debug</a></p>

      </td>
<td>

      </td>
</tr>
<tr>
<td>

        <p><a href="kotlinx.coroutines.debug.junit4/index.html">kotlinx.coroutines.debug.junit4</a></p>

      </td>
<td>

      </td>
</tr>
</tbody>
</table>

<h3 id="index">Index</h3>

<p><a href="alltypes/index.html">All Types</a></p>

      </div>
    </main>
    <footer class="site-footer">
  <!-- empty -->
</footer>

  </body>
</html>

